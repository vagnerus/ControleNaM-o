/**
 * Core Philosophy:
 * This ruleset enforces a strict, multi-tenant user-ownership model. All user data is
 * stored in subcollections under a top-level `/users/{userId}` path. Access is granted
 * if, and only if, the requesting user's authenticated UID matches the {userId} in the
 * document path. This ensures that users can only ever access their own data, providing
 * strong data isolation.
 *
 * Data Structure:
 * All application data is organized hierarchically under the `/users` collection. For example,
 * a user's transactions are stored at `/users/{userId}/transactions/{transactionId}`. This
 * structure is the foundation of the security model, making authorization checks simple,
 * performant, and easy to reason about.
 *
 * Key Security Decisions:
 * - Strict Ownership: All data is private. There are no shared or public collections.
 * - No User Listing: There is no rule for the `/users` collection itself, which securely
 *   prevents any client from listing all users in the application.
 * - Path-Based Security: Authorization is derived directly from the document path, which
 *   avoids the need for slow and costly `get()` calls to other documents.
 * - Write Operations: All writes (create, update, delete) are strictly limited to the
 *   document owner. Update and delete operations further require that the document
 *   already exists.
 *
 * Developer Note on "auth/operation-not-allowed":
 * The error `Firebase: Error (auth/operation-not-allowed)` typically indicates that the
 * sign-in method being used (e.g., Anonymous, Email/Password) has not been enabled in the
 * Firebase Authentication console. Please verify that all intended sign-in providers are
 * enabled in your Firebase project settings.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the requesting user's UID matches the userId from the path.
     * This is the core function for enforcing user ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    /**
     * For update and delete, ensures the user is the owner AND the document exists.
     * This prevents modifying or deleting non-existent documents.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    // ------------------------------------------------------------------------
    // User Data Rules
    // ------------------------------------------------------------------------

    match /users/{userId} {
      // Deny reads/writes to the user document itself by default.
      // Rules for subcollections are defined below.
      allow read, write: if false;
      
      /**
       * @description Secures the user's private financial transactions.
       * @path /users/{userId}/transactions/{transactionId}
       * @allow A logged-in user (uid: 'user_abc') creating their own transaction document at `/users/user_abc/transactions/tx_123`. (create)
       * @deny Another user (uid: 'user_xyz') trying to read a transaction at `/users/user_abc/transactions/tx_123`. (get)
       * @principle Restricts access to a user's own data tree.
       */
      match /transactions/{transactionId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update, delete: if isExistingOwner(userId);
      }

      /**
       * @description Secures the user's private spending and income categories.
       * @path /users/{userId}/categories/{categoryId}
       * @allow A logged-in user (uid: 'user_abc') listing all their categories at `/users/user_abc/categories`. (list)
       * @deny An unauthenticated user trying to create a category at `/users/user_abc/categories/cat_456`. (create)
       * @principle Restricts access to a user's own data tree.
       */
      match /categories/{categoryId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update, delete: if isExistingOwner(userId);
      }

      /**
       * @description Secures the user's private subcategories.
       * @path /users/{userId}/subcategories/{subcategoryId}
       * @allow A logged-in user (uid: 'user_abc') updating their own subcategory at `/users/user_abc/subcategories/sub_789`. (update)
       * @deny A logged-in user (uid: 'user_abc') trying to delete a subcategory belonging to another user (`/users/user_xyz/...`). (delete)
       * @principle Restricts access to a user's own data tree.
       */
      match /subcategories/{subcategoryId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update, delete: if isExistingOwner(userId);
      }

      /**
       * @description Secures the user's private financial accounts.
       * @path /users/{userId}/accounts/{accountId}
       * @allow A logged-in user (uid: 'user_abc') reading their own account at `/users/user_abc/accounts/acc_123`. (get)
       * @deny Another user (uid: 'user_xyz') trying to list accounts at `/users/user_abc/accounts`. (list)
       * @principle Restricts access to a user's own data tree.
       */
      match /accounts/{accountId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update, delete: if isExistingOwner(userId);
      }

      /**
       * @description Secures file attachments (e.g., receipts) for a user's transactions.
       * @path /users/{userId}/attachments/{attachmentId}
       * @allow A logged-in user (uid: 'user_abc') deleting their own attachment document at `/users/user_abc/attachments/att_456`. (delete)
       * @deny A logged-in user (uid: 'user_abc') trying to update an attachment that does not exist. (update)
       * @principle Restricts access to a user's own data tree.
       */
      match /attachments/{attachmentId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update, delete: if isExistingOwner(userId);
      }

      /**
       * @description Secures the user's private tags for organizing transactions.
       * @path /users/{userId}/tags/{tagId}
       * @allow A logged-in user (uid: 'user_abc') creating a new tag at `/users/user_abc/tags/tag_789`. (create)
       * @deny An unauthenticated user trying to get any tag. (get)
       * @principle Restricts access to a user's own data tree.
       */
      match /tags/{tagId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update, delete: if isExistingOwner(userId);
      }

      /**
       * @description Secures the user's private credit card information.
       * @path /users/{userId}/creditCards/{creditCardId}
       * @allow A logged-in user (uid: 'user_abc') listing their credit cards at `/users/user_abc/creditCards`. (list)
       * @deny Another user (uid: 'user_xyz') trying to read a credit card at `/users/user_abc/creditCards/cc_123`. (get)
       * @principle Restricts access to a user's own data tree.
       */
      match /creditCards/{creditCardId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update, delete: if isExistingOwner(userId);
      }

      /**
       * @description Secures the user's private installment payment records.
       * @path /users/{userId}/installments/{installmentId}
       * @allow A logged-in user (uid: 'user_abc') updating an installment at `/users/user_abc/installments/inst_456`. (update)
       * @deny A logged-in user (uid: 'user_abc') trying to create an installment for another user (`/users/user_xyz/...`). (create)
       * @principle Restricts access to a user's own data tree.
       */
      match /installments/{installmentId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update, delete: if isExistingOwner(userId);
      }

      /**
       * @description Secures the user's private monthly budgets.
       * @path /users/{userId}/budgets/{budgetId}
       * @allow A logged-in user (uid: 'user_abc') creating a budget at `/users/user_abc/budgets/bud_789`. (create)
       * @deny Another user (uid: 'user_xyz') trying to delete a budget at `/users/user_abc/budgets/bud_789`. (delete)
       * @principle Restricts access to a user's own data tree.
       */
      match /budgets/{budgetId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update, delete: if isExistingOwner(userId);
      }

      /**
       * @description Secures the user's private financial goals.
       * @path /users/{userId}/financialGoals/{financialGoalId}
       * @allow A logged-in user (uid: 'user_abc') reading their own goal at `/users/user_abc/financialGoals/goal_123`. (get)
       * @deny An unauthenticated user trying to list goals at `/users/user_abc/financialGoals`. (list)
       * @principle Restricts access to a user's own data tree.
       */
      match /financialGoals/{financialGoalId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update, delete: if isExistingOwner(userId);
      }
    }
  }
}